We want to setup an audit of the Cisco IOS hardening recommendations.
# Audit Configuration

## Simple Check
```
cat run-checks.yml
---
- name:  "Check every test in folder ./tests"
  hosts: all
  tasks:
  - include_tasks: "{{item}}"
    with_fileglob: [ "tests/*.yml" ]
    ignore_errors: true
```

```
cat group_vars/all.yml
---
snmp_server: 192.168.122.2
snmp_community: cisco
syslog_server: 192.168.122.2
ntp_server_1: ntp server 216.239.35.0
ntp_server_2: ntp server 216.239.35.4
```

## Generate JSON Reports


```
cat report-results.yml
#
# Read JSON file generated by the "compliance checks" Ansible
# playbook and generate a summary report
#
# Inputs (specified as extra-vars)
#
# - input: file name
# - format: Jinja2 template name (in reports directory)
# - output: Outout file name
#
# Defaults:
# - format = json-simple.j2
# - output = errors-txt.j2
#
---
- hosts: all
  tasks:
  - assert:
      that: input is defined
      msg:  Have to specify INPUT extra variable
  - set_fact:
      json_data: "{{ lookup('file',input)|from_json }}"
  - set_fact:
      results: "{{ json_data|json_query('plays[].tasks[]') }}"
  - template:
      src:  "templates/{{format|default('json-simple')}}.j2"
      dest: "results/{{output|default('errors.txt')}}"
```

# Tests in tests/ folder
We want to execute custom tests created in the `tests/` folder.
## Check NTP
### NTP Servers
We want to verify that we have two NTP servers configured.  IPs are to be used since DNS should be disabled on a hardened Cisco IOS device.  [Google's NTP Servers](https://cloudplatform.googleblog.com/2016/11/making-every-leap-second-count-with-our-new-public-NTP-servers.html) are used herein.
```
cat << EOF > tests/ntp-server-1.yml
---
- name: "Check: 216.239.35.0 configured as ntp server"
  ios_command:
    commands: "show run | inc ntp server 216.239.35.0"
  register: result
  failed_when: "not('ntp server 216.239.35.0' in result.stdout[0])"
  ignore_errors: yes
EOF
```
```
cat tests/ntp-server-2.yml
---
- name: "Check: 216.239.35.4 configured as ntp server"
  ios_command:
    commands: "show run | inc ntp server 216.239.35.4"
  register: result
  failed_when: "not('ntp server 216.239.35.4' in result.stdout[0])"
  ignore_errors: yes
```
### NTP Sync
Let's check to see if the configured NTP settings have resulted in synchronized time.
```
cat tests/ntp-status.yml
---
- name: "Check: NTP status"
  ios_command:
    commands: "show ntp status | inc Clock is "
  register: result
  failed_when: "not('Clock is sync' in result.stdout[0])"
  ignore_errors: yes
```

## Verify DNS Lookup Disabled
```
cat tests/domain-lookup.yml
---
- name: "Check: Ensure DNS lookups are disabled"
  ios_command:
    commands: "show run | include ip domain lookup"
  register: result
  failed_when: "not('no ip domain lookup' in result.stdout[0])"
  ignore_errors: yes
```

## Verify MOTD 
```
cat tests/banner-motd.yml
---
- name: "Check: banner motd"
  ios_command:
    commands: "sho run | inc (banner motd|lab environment)"
  register: result
  failed_when: "not('lab environment' in result.stdout[0])"
  ignore_errors: yes
```
## Verify logging 
Logging server configured as per group_var/all.yml file.
```
cat tests/logging-server.yml
---
- name: "Check: {{syslog_server}} is configured as syslog server"
  ios_command:
    commands: "show run | include logging host {{syslog_server}}"
  register: result
  failed_when: "not('logging host '~syslog_server in result.stdout[0])"
  ignore_errors: yes
```
Logging buffer:
```
cat tests/logging-buffer.yml
---
- name: "Check: Verify logging buffer"
  ios_command:
    commands: "show run | inc logging buffered 15000"
  register: result
  failed_when: "not('logging buffered 15000'  in result.stdout[0])"
  ignore_errors: yes

```
## Verify SNMP 
### trap server 192.168.122.2
```
cat tests/snmp-server.yml
---
- name: "Check: {{snmp_server}} is not configured as SNMP trap host"
  ios_command:
    commands: "show snmp host"
  register: result
  failed_when: "not('host: '~snmp_server in result.stdout[0])"
  ignore_errors: yes
```
### SNMP Community
```
cat tests/snmp-community.yml
#
# Check whether SNMP community is configured on devices
#
---
- name: "Check: SNMP community {{snmp_community}} is not defined"
  ios_command:
    commands: "show snmp community"
  register: result
  failed_when: "not('name: '~snmp_community in result.stdout[0])"
  ignore_errors: yes
```

## Check user 's3cur3' and password 's3cur3_'
```
cat tests/usersecure.yml
---
- name: "Check: Ensure username secure with good password is used"
  ios_command:
    commands: "show run | include username s3cur3 privilege 15 password 0 s3cur3_"
  register: result
  failed_when: "not('username s3cur3 privilege 15 password 0 s3cur3_' in result.stdout[0])"
  ignore_errors: yes
```
## Check VTY ACL

```
cat tests/vty-acl.yml
---
- name: "Check: VTY ACL"
  ios_command:
    commands: "show run | sec vty 0"
  register: result
  failed_when: "not(' access-class ' in result.stdout[0])"
  ignore_errors: yes

```

## Verify http/https servers Disabled
```
cat tests/http-disable.yml
---
- name: "Check: http server status"
  tags: http
  ios_command:
    commands: "show run | inc ip http server"
  register: result
  failed_when: "not('no ip http server' in result.stdout[0])"
  ignore_errors: yes
```

```
cat tests/https-disable.yml
---
- name: "Check: https server status"
  tags: http
  ios_command:
    commands: "show run | inc ip http secure-server"
  register: result
  failed_when: "not('no ip http secure-server' in result.stdout[0])"
  ignore_errors: yes
```

## Verify Proxy Arp Disabled

## Verify BGP Route Dampening Disabled
```
cat tests/bgp-dampening.yml
---
- name: "Check: bgp dampening"
  ios_command:
    commands: "show run | inc bgp dampening"
  register: result
  failed_when: "not('bgp dampening' in result.stdout[0])"
  ignore_errors: yes
```

## Verify OSPF Authentication Enabled

## Verify TCP Connection Keep Alives Inbound Enabled
```
cat tests/tcp-keepalives.yml
---
- name: "Check: Verify service tcp-keepalives-in is enabled"
  ios_command:
    commands: "show run | inc service tcp-keepalives-in"
  register: result
  failed_when: "not('service tcp-keepalives-in'  in result.stdout[0])"
  ignore_errors: yes
```

## vty timeout
## Verify service pad Is Disabled
```
cat tests/disable-pad.yml
# Verify that pad is disabled
---
- name: "Check: Verify pad is disabled"
  ios_command:
    commands: "show run | inc no service pad"
  register: result
  failed_when: "not('no service pad'  in result.stdout[0])"
  ignore_errors: yes
```
## Verify CDP Disabled
```
cat tests/disable-cdp.yml
# Check if CDP is disabled

---
- name: "Check: Verify CDP is disabled"
  ios_command:
    commands: "show run | inc no cdp run"
  register: result
  failed_when: "not('no cdp run'  in result.stdout[0])"
  ignore_errors: yes
```

## Secure AUX
```
cat tests/disable-aux.yml
---
- name: "Check: Status of AUX"
  ios_command:
    commands: "show run | sec aux 0"
  register: result
  failed_when: "not(' no exec' in result.stdout[0])"
  ignore_errors: yes
```
##  securing interfaces

## Verify Source Routing Disabled
```
cat tests/disable-source-routing.yml
---
- name: "Check: Source Routing Disabled"
  ios_command:
    commands: "show run | inc no ip source-route"
  register: result
  failed_when: "not('no ip source-route' in result.stdout[0])"
  ignore_errors: yes
```
## vty 0
### disable telnet and only allow ssh into vty 0
```
cat tests/vty-transport.yml
---
- name: "Check: Ensure transport input is ssh"
  ios_command:
    commands: "sho run | section vty"
  register: result
  failed_when: "not('transport input ssh'  in result.stdout[0])"
  ignore_errors: yes
```
### ssh version 2 
```
cat tests/vty-ssh2.yml
---
- name: "Check: Verify ssh2 is running"
  ios_command:
    commands: "show run | inc ip ssh version 2"
  register: result
  failed_when: "not('ip ssh version 2'  in result.stdout[0])"
  ignore_errors: yes
```
### VTY ACL
```
cat tests/vty-acl.yml
---
- name: "Check: VTY ACL"
  ios_command:
    commands: "show run | sec vty 0"
  register: result
  failed_when: "not(' access-class ' in result.stdout[0])"
  ignore_errors: yes
```

## disable ICMP redirects
## Verify TZ
Time Zone
UTC Offset
Summer Time Zone
Authorative Time Source

# Running These Tests
## Simple Check
```
# For simple checking, it is nice to have rtr1 perfect and rtr3 with
# many problems and then run the below command.
ansible-playbook run-checks.yml -k -v --limit dc1
# appended text

TASK [Check: NTP status] *******************************************************
fatal: [rtr3]: FAILED! => {"changed": false, "failed_when_result": true, "stdout": [""], "stdout_lines": [[""]]}
...ignoring
ok: [rtr1]

```

## More Complex Reporting using JSON
For this to work, you must have you plugins working properly including dense.
```
cat do-checks.sh
#!/bin/bash
#
set -e
echo "Performing compliance checks..."
ANSIBLE_STDOUT_CALLBACK=json \
  ansible-playbook run-checks.yml -k >/tmp/$$.json
echo "... done"
echo
echo "Generating reports from $$.json"
ANSIBLE_STDOUT_CALLBACK=dense \
  ansible-playbook report-results.yml -k -e input=/tmp/$$.json
echo
echo "Cleanup"
rm /tmp/$$.json
```